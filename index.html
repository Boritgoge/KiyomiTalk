<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- import CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
</head>
<body>
    <div id="app">
        <el-table
            :data="chats"
            :show-header="false"
        >
            <el-table-column prop="nick"/>            
            <el-table-column prop="content"/>            
        </el-table>
        <el-input placeholder="입력해용" v-model="input" @keypress.native.enter="write" v-loading="loading"/>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getDatabase, ref, update, onValue, push, child } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC6bjzsZjvjZ7MQtmwdhw8K8KZAeQI530k",
        authDomain: "fcm-simulator-f6908.firebaseapp.com",
        projectId: "fcm-simulator-f6908",
        storageBucket: "fcm-simulator-f6908.appspot.com",
        messagingSenderId: "800381183411",
        appId: "1:800381183411:web:87a64b0ab047ef39d597c6",
        measurementId: "G-LSTN6W98V4"
    };
    
    const app = initializeApp(firebaseConfig);

    new Vue({
        el: '#app',
        data() {
            return {
                loading: false,
                chats: [],
                input: "",
            }
        },
        mounted() {
            this.loading = true;
            this.read();

        },
        methods: {
            write() {
                const db = getDatabase(app);
                const newChatKey = push(child(ref(db), 'posts')).key;
                const updates = {}
                updates[`/chats/${newChatKey}`] = {
                    nick: '고수',
                    content: this.input
                }
                update(ref(db), updates)
                this.input='';
            },
            read() {
                const db = getDatabase();
                const chatRef = ref(db, 'chats');
                onValue(chatRef, (snapshot) => {
                    const data = snapshot.val() || [];
                    this.chats = Object.keys(data).reduce((list, key) => {
                        list.push(data[key]);
                        return list;
                    }, []);
                    this.loading = false;
                });
            }
        }
    })
    </script>
</html>